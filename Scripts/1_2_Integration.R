library(Seurat)
library(SeuratObject)
library(pheatmap)
library(gridExtra)
library(ggplot2)
library(ggpubr)
library(cowplot)
library(Matrix)
library(R6)
library(dplyr)
library(tidyverse)
library(purrr)
library(harmony)
library(plyr)

#0. read data-------------------------------------------
out="~/path_to_output/"
data=readRDS(paste0(out,"rds/samples_merge.rds"))

# 1.scaling---------------------------------------

data=data %>%
  NormalizeData()%>%
  FindVariableFeatures(nfeatures=3000) %>%
  ScaleData(vars.to.regress = c("nFeature_RNA", "percent.mt")) %>%
  RunPCA(npcs=50) %>%
  RunUMAP(dims=1:30)


# 2. Integration-------------------------------

data=RunHarmony(data, group.by.vars="orig.ident",dim.use=1:30,max.iter.harmony=50)
data=RunUMAP(data,reduction="harmony",dim=1:30)


saveRDS(data,paste0(out,"rds/sample_merge_integrtion.rds"))


# Stage	Key code	Purpose / effect
# Load packages	library(Seurat) … library(plyr)	Brings in the Seurat ecosystem, plotting libraries, and Harmony for batch integration.
# Read merged object	data ← readRDS("…/samples_merge.rds")	Loads the multi-sample Seurat object generated by the first script.
# 1. Standard preprocessing	r data = data %>% NormalizeData() %>% FindVariableFeatures(nfeatures = 3000) %>% ScaleData(vars.to.regress = c("nFeature_RNA","percent.mt")) %>% RunPCA(npcs = 50) %>% RunUMAP(dims = 1:30)	* Re-normalises counts (log-normalisation).
# * Re-identifies the 3 000 most variable genes.
# * ScaleData: centres/scales each gene and regresses out library size (nFeature_RNA) and mitochondrial % (percent.mt).
# * Computes 50 principal components.
# * Calculates a UMAP embedding on PCs 1–30 (pre-integration view, useful for QC).
# 2. Batch integration with Harmony	r data = RunHarmony(data, group.by.vars = "orig.ident", dim.use = 1:30, max.iter.harmony = 50) data = RunUMAP(data, reduction = "harmony", dim = 1:30)	* RunHarmony removes sample-specific batch effects, using orig.ident (the original sample IDs) as the batch label and the first 30 PCs as input.
# * A second UMAP is computed, this time on the batch-corrected “harmony” embeddings, giving an integrated visualisation where cells from different samples should mix by biology rather than by batch.
# Save integrated object	saveRDS(data, "…/sample_merge_integrtion.rds")	Stores the fully processed, batch-corrected Seurat object to disk for downstream clustering, marker discovery, differential expression, etc.
# In plain language

# Load the previously merged single-cell dataset.
# Normalise, scale and perform PCA while regressing out library-size and mitochondrial read effects.
# Visualise the uncorrected data with an initial UMAP.
# Integrate batches using Harmony so that technical differences between samples (orig.ident) are removed.
# Re-embed the Harmony space with a second UMAP for a clean, integrated view.
# Save the processed object for any further analysis.



